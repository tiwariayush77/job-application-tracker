<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Job Tracker (Clean)</title>
<style>
  :root{--bg:#0e3a69;--acc:#2b85f7;--ok:#1b5e20;--err:#b71c1c;--mut:#6b7b8c}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:linear-gradient(135deg,#2b85f7 0%,#0e3a69 100%);min-height:100vh;padding:20px;color:#132739}
  .wrap{max-width:1100px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.25);padding:18px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .h{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  h1{font-size:20px}
  button,.btn{padding:9px 12px;border:0;border-radius:8px;background:var(--acc);color:#fff;cursor:pointer;font-weight:700}
  button:disabled{opacity:.6;cursor:not-allowed}
  .sec{background:#f6f9ff;border:1px solid #dee8ff;border-radius:10px;padding:12px;margin:10px 0}
  label{font-size:12px;font-weight:700;color:#0e3a69}
  input,select,textarea{border:1px solid #c8d6f0;border-radius:8px;padding:9px;background:#fff;width:100%}
  textarea{min-height:70px;resize:vertical}
  .grid{display:grid;gap:10px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:1fr 1fr 1fr}
  @media(max-width:900px){.g2,.g3{grid-template-columns:1fr}}
  .tabbar{display:flex;gap:8px;margin:8px 0}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid #d9e6ff;background:#eef5ff;cursor:pointer}
  .tab.active{background:var(--acc);color:#fff}
  table{width:100%;border-collapse:collapse;background:#fff}
  th,td{padding:10px;border-bottom:1px solid #eef2fb;text-align:left;font-size:14px}
  th{background:#0e3a69;color:#fff;font-size:12px;text-transform:uppercase}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
  .ok{background:#e8f5e9;color:#1b5e20}.err{background:#ffebee;color:#b71c1c}.mut{background:#eef5ff;color:#0e3a69}
  .note{font-size:12px;color:#577091}
</style>
</head>
<body>
<div class="wrap">
  <div class="h"><h1>Job Application Tracker (Clean)</h1>
    <div class="row">
      <button id="exportJson">Export JSON</button>
      <input type="file" id="importJson" accept="application/json" style="display:none"/>
      <button id="importBtn" class="btn">Import JSON</button>
      <button id="syncBtn" disabled>☁️ Sync</button>
    </div>
  </div>

  <div class="sec">
    <div class="grid g3">
      <div>
        <label>GitHub Token (gist scope)</label>
        <input id="ghToken" type="password" placeholder="ghp_xxxxxx"/>
      </div>
      <div>
        <label>Gist ID</label>
        <input id="gistId" placeholder="Auto-create on first sync" readonly/>
      </div>
      <div class="grid">
        <div class="note" id="syncStatus"><span class="pill mut">Not connected</span></div>
        <div class="row">
          <button id="saveTok">Save Token</button>
          <button id="clearTok">Clear Token</button>
          <button id="pullNow">Pull</button>
          <button id="pushNow">Push</button>
        </div>
      </div>
    </div>
    <div class="note">Token is stored locally; data syncs to a private Gist file job-applications.json.</div>
  </div>

  <div class="tabbar">
    <div class="tab active" data-tab="pre">Pre‑Apply</div>
    <div class="tab" data-tab="active">Active</div>
    <div class="tab" data-tab="new">Add</div>
  </div>

  <div id="pre" class="sec">
    <div class="row" style="justify-content:space-between">
      <div class="note">Items marked “Will Apply”.</div>
      <div class="row">
        <input id="searchPre" placeholder="Search company/role" />
        <select id="prePath"><option value="">All paths</option><option>Referrals</option><option>Job Link</option><option>Both</option><option>TBD</option></select>
      </div>
    </div>
    <table id="preTable">
      <thead><tr><th>Company</th><th>Role</th><th>Path</th><th>Pre‑Status</th><th>JD</th><th>Referrals</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="active" class="sec" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="note">Applied → Interviewing → Offer/Accepted</div>
      <div class="row">
        <select id="filterStatus"><option value="">All</option><option>Applied</option><option>Interviewing</option><option>Offer</option><option>Rejected</option><option>Withdrawn</option><option>Accepted</option></select>
        <input id="searchActive" placeholder="Search company/role" />
      </div>
    </div>
    <table id="activeTable">
      <thead><tr><th>Company</th><th>Role</th><th>Status</th><th>Priority</th><th>Next</th><th>Source</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="new" class="sec" style="display:none">
    <div class="grid g3">
      <div><label>Company</label><input id="fCompany"/></div>
      <div><label>Role</label><input id="fRole"/></div>
      <div><label>Location</label><input id="fLoc"/></div>
      <div><label>Job URL</label><input id="fUrl" placeholder="https://..."/></div>
      <div><label>Status</label><select id="fStatus"><option>Applied</option><option>Interviewing</option><option>Offer</option><option>Rejected</option><option>Withdrawn</option><option>Accepted</option></select></div>
      <div><label>Priority</label><select id="fPri"><option>Medium</option><option>High</option><option>Low</option></select></div>
      <div><label>Date Applied</label><input id="fDate" type="date"/></div>
      <div><label>Next Follow-up</label><input id="fNext" type="date"/></div>
      <div><label>Source</label><input id="fSource" placeholder="LinkedIn/Referral"/></div>
      <div class="grid" style="grid-column:1/-1">
        <label>Pre‑Apply</label>
        <div class="row"><input type="checkbox" id="fWill"/> <span class="note">Will Apply (pipeline)</span></div>
      </div>
      <div><label>Apply Path</label><select id="fPath"><option>TBD</option><option>Referrals</option><option>Job Link</option><option>Both</option></select></div>
      <div><label>Pre‑Status</label><select id="fPre"><option>Researching</option><option>Drafting Resume</option><option>Outreach</option><option>Waiting Referral</option><option>Ready to Submit</option></select></div>
      <div><label>JD Link</label><input id="fJd" placeholder="https://..."/></div>
      <div style="grid-column:1/-1"><label>JD Summary</label><textarea id="fJdSum" placeholder="Key requirements, team, must-haves..."></textarea></div>
      <div style="grid-column:1/-1"><label>Notes</label><textarea id="fNotes"></textarea></div>
    </div>
    <div class="row" style="justify-content:flex-end"><button id="addBtn">Add</button></div>
  </div>
</div>

<script>
/* State */
let applications = JSON.parse(localStorage.getItem('jobApplications')||'[]');
let githubToken = localStorage.getItem('githubToken')||'';
let gistId = localStorage.getItem('gistId')||'';
const $=id=>document.getElementById(id);

/* Tabs */
document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  ['pre','active','new'].forEach(id=>$(id).style.display='none');
  $(t.dataset.tab).style.display='block';
});

$('importBtn').onclick=()=>$('importJson').click();
$('importJson').onchange=e=>{
  const file=e.target.files[0]; if(!file) return;
  const r=new FileReader();
  r.onload=()=>{ try{ const data=JSON.parse(r.result); if(Array.isArray(data)){ applications=data; saveLocal(); renderAll(); toast('Imported', true); } }catch(err){ toast('Import failed', false); } };
  r.readAsText(file);
};
$('exportJson').onclick=()=>{
  const blob=new Blob([JSON.stringify(applications,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='job-applications.json'; a.click(); URL.revokeObjectURL(url);
};

function saveLocal(){ localStorage.setItem('jobApplications', JSON.stringify(applications)); }
function toast(msg, ok){ $('syncStatus').innerHTML = `<span class="pill ${ok?'ok':'err'}">${msg}</span>`; }

/* Renderers */
function renderPre(){
  const q=($('searchPre').value||'').toLowerCase();
  const p=$('prePath').value||'';
  const list=applications.filter(a=>a.willApply)
    .filter(a=>!p || a.applyPath===p)
    .filter(a=>(a.companyName||'').toLowerCase().includes(q) || (a.jobTitle||'').toLowerCase().includes(q));
  const rows = list.map((a,i)=>`<tr>
    <td>${esc(a.companyName)}</td>
    <td>${esc(a.jobTitle)}</td>
    <td>${esc(a.applyPath||'TBD')}</td>
    <td>${esc(a.preStatus||'Researching')}</td>
    <td>${a.jdLink?`<a href="${a.jdLink}" target="_blank">JD</a>`:'-'}</td>
    <td>${(a.referralContacts||[]).length||0}</td>
    <td><button onclick="editItem(${applications.indexOf(a)})">Edit</button> <button onclick="delItem(${applications.indexOf(a)})">Delete</button></td>
  </tr>`).join('') || `<tr><td colspan="7" class="note">No planned applications</td></tr>`;
  $('preTable').querySelector('tbody').innerHTML = rows;
}
function renderActive(){
  const st=$('filterStatus').value||''; const q=($('searchActive').value||'').toLowerCase();
  const list=applications
    .filter(a=>!a.willApply)
    .filter(a=>!st || a.status===st)
    .filter(a=>(a.companyName||'').toLowerCase().includes(q) || (a.jobTitle||'').toLowerCase().includes(q));
  const rows = list.map((a,i)=>`<tr>
    <td>${esc(a.companyName)}</td><td>${esc(a.jobTitle)}</td>
    <td>${esc(a.status||'Applied')}</td><td>${esc(a.priority||'Medium')}</td>
    <td>${esc(a.nextFollowUp||'')}</td><td>${esc(a.referralSource||'')}</td>
    <td><button onclick="editItem(${applications.indexOf(a)})">Edit</button> <button onclick="delItem(${applications.indexOf(a)})">Delete</button></td>
  </tr>`).join('') || `<tr><td colspan="7" class="note">No applications</td></tr>`;
  $('activeTable').querySelector('tbody').innerHTML = rows;
}
function renderAll(){ renderPre(); renderActive(); }

function esc(s){ return (s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

/* Add/Edit/Delete */
$('fDate').valueAsDate=new Date();
$('addBtn').onclick=()=>{
  const a={ id:Date.now(),
    companyName:$('fCompany').value.trim(), jobTitle:$('fRole').value.trim(), jobUrl:$('fUrl').value.trim(),
    location:$('fLoc').value.trim(), dateApplied:$('fDate').value, status:$('fStatus').value, salary:'',
    priority:$('fPri').value, contactPerson:'', contactEmail:'', referralSource:$('fSource').value.trim(),
    nextFollowUp:$('fNext').value, notes:$('fNotes').value.trim(),
    willApply:$('fWill').checked, applyPath:$('fPath').value, preStatus:$('fPre').value, jdLink:$('fJd').value.trim(),
    jdSummary:$('fJdSum').value.trim(), referralContacts:[]
  };
  applications.unshift(a); saveLocal(); renderAll(); toast('Added', true);
  if (githubToken) pushNow();
  // reset minimal
  ['fCompany','fRole','fUrl','fLoc','fSource','fNotes','fJd','fJdSum'].forEach(id=>$(id).value='');
  $('fWill').checked=false; $('fPath').value='TBD'; $('fPre').value='Researching'; $('fPri').value='Medium'; $('fStatus').value='Applied'; $('fNext').value='';
};

window.editItem=(idx)=>{
  const a=applications[idx]; if(!a) return;
  // put into Add form for quick edits
  $('fCompany').value=a.companyName||''; $('fRole').value=a.jobTitle||''; $('fUrl').value=a.jobUrl||'';
  $('fLoc').value=a.location||''; $('fDate').value=a.dateApplied||''; $('fStatus').value=a.status||'Applied';
  $('fPri').value=a.priority||'Medium'; $('fSource').value=a.referralSource||''; $('fNext').value=a.nextFollowUp||'';
  $('fWill').checked=!!a.willApply; $('fPath').value=a.applyPath||'TBD'; $('fPre').value=a.preStatus||'Researching';
  $('fJd').value=a.jdLink||''; $('fJdSum').value=a.jdSummary||''; $('fNotes').value=a.notes||'';
  document.querySelector('[data-tab="new"]').click();
  // on next Add click, treat as update
  $('addBtn').onclick=()=>{
    const b={...a,
      companyName:$('fCompany').value.trim(), jobTitle:$('fRole').value.trim(), jobUrl:$('fUrl').value.trim(),
      location:$('fLoc').value.trim(), dateApplied:$('fDate').value, status:$('fStatus').value,
      priority:$('fPri').value, referralSource:$('fSource').value.trim(), nextFollowUp:$('fNext').value,
      willApply:$('fWill').checked, applyPath:$('fPath').value, preStatus:$('fPre').value,
      jdLink:$('fJd').value.trim(), jdSummary:$('fJdSum').value.trim(), notes:$('fNotes').value.trim(),
      updatedAt:new Date().toISOString()
    };
    applications[idx]=b; saveLocal(); renderAll(); toast('Updated', true); if(githubToken) pushNow();
    $('addBtn').onclick=defaultAdd; // restore handler
  };
};
const defaultAdd=$('addBtn').onclick;

window.delItem=(idx)=>{
  if(!confirm('Delete this entry?')) return;
  applications.splice(idx,1); saveLocal(); renderAll(); toast('Deleted', true); if(githubToken) pushNow();
};

/* Filters */
$('searchPre').oninput=renderPre; $('prePath').onchange=renderPre;
$('searchActive').oninput=renderActive; $('filterStatus').onchange=renderActive;

/* Sync */
$('ghToken').value=githubToken||''; $('gistId').value=gistId||'';
$('saveTok').onclick=()=>{ const v=$('ghToken').value.trim(); if(!v){ toast('Token empty',false); return;} githubToken=v; localStorage.setItem('githubToken',v); $('syncBtn').disabled=false; toast('Token saved',true); };
$('clearTok').onclick=()=>{ githubToken=''; localStorage.removeItem('githubToken'); toast('Token cleared',true); };
$('syncBtn').onclick=()=> pushNow();
$('pullNow').onclick=()=> pullNow();
$('pushNow').onclick=()=> pushNow();

async function createGistIfNeeded(){
  if(!githubToken) { toast('Add token',false); return false; }
  if(gistId) return true;
  toast('Creating backup...', true);
  const payload={description:'Job Application Tracker (Clean)', public:false, files:{'job-applications.json':{content: JSON.stringify({applications, updatedAt:new Date().toISOString()},null,2)}}};
  const r=await fetch('https://api.github.com/gists',{method:'POST',headers:{'Authorization':`token ${githubToken}`,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'},body:JSON.stringify(payload)});
  if(r.ok){ const j=await r.json(); gistId=j.id; localStorage.setItem('gistId',gistId); $('gistId').value=gistId; toast('Backup created',true); return true; }
  toast('Create failed',false); return false;
}
async function pushNow(){
  if(!githubToken){ toast('Add token',false); return; }
  if(!gistId){ const ok=await createGistIfNeeded(); if(!ok) return; }
  toast('Syncing...',true);
  const payload={files:{'job-applications.json':{content: JSON.stringify({applications, updatedAt:new Date().toISOString()},null,2)}}};
  const r=await fetch(`https://api.github.com/gists/${gistId}`,{method:'PATCH',headers:{'Authorization':`token ${githubToken}`,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'},body:JSON.stringify(payload)});
  if(r.ok) toast('Synced',true); else toast('Sync failed',false);
}
async function pullNow(){
  if(!githubToken || !gistId){ toast('Add token & gist id',false); return; }
  toast('Loading...',true);
  const r=await fetch(`https://api.github.com/gists/${gistId}`,{headers:{'Authorization':`token ${githubToken}`,'Accept':'application/vnd.github.v3+json'}});
  if(r.ok){ const j=await r.json(); const file=j.files['job-applications.json']; if(file&&file.content){ const data=JSON.parse(file.content); if(Array.isArray(data.applications)){ applications=data.applications; saveLocal(); renderAll(); toast('Loaded',true); return; }} }
  toast('Load failed',false);
}

/* Auto-pull if local empty and creds exist */
if(!applications.length && githubToken && gistId){ pullNow(); }
renderAll();
</script>
</body>
</html>

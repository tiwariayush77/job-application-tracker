<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Job Application Tracker | Nordic Blues</title>
<style>
/* styles kept as in current main (omitted here for brevity in diff) */
</style>
</head>
<body>
<div class="container">
  <!-- header + cloud + stats + form + table blocks remain exactly as in current main -->
</div>
<script>
/* --- existing UI code from current main preserved above this line --- */

// ===== GIST SYNC: fully restored handlers =====
let githubToken = localStorage.getItem('githubToken') || '';
let gistId = localStorage.getItem('gistId') || '';
let autoSyncEnabled = (localStorage.getItem('autoSync') === 'true');

function setupGitHubSync(){
  const token = document.getElementById('githubToken').value.trim();
  if(!token){ githubToken=''; localStorage.removeItem('githubToken'); updateCloudStatus(); return; }
  githubToken = token; localStorage.setItem('githubToken', githubToken);
  autoSyncEnabled = true; localStorage.setItem('autoSync','true');
  if(!gistId){ createInitialGist(); } else { syncFromGist(true); }
  updateCloudStatus();
}

async function createInitialGist(){
  if(!githubToken) return;
  updateSyncIndicator('syncing','Creating backup...');
  try{
    const gistData={ description:"Job Application Tracker - Nordic Blues Edition", public:false, files:{"job-applications.json":{content: JSON.stringify({ applications, lastUpdated:new Date().toISOString(), version:"1.0" },null,2)}}};
    const r=await fetch('https://api.github.com/gists',{method:'POST',headers:{'Authorization':`token ${githubToken}`,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'},body:JSON.stringify(gistData)});
    if(r.ok){ const j=await r.json(); gistId=j.id; localStorage.setItem('gistId', gistId); document.getElementById('gistId').value=gistId; updateSyncIndicator('synced','Backup created!'); }
    else throw new Error(r.status);
  }catch(e){ console.error(e); updateSyncIndicator('error','Backup failed'); }
}

async function syncToGist(){
  if(!githubToken || !gistId) return;
  updateSyncIndicator('syncing','Syncing...');
  try{
    const gistData={ files:{"job-applications.json":{content: JSON.stringify({ applications, lastUpdated:new Date().toISOString(), version:"1.0" },null,2)}}};
    const r=await fetch(`https://api.github.com/gists/${gistId}`,{method:'PATCH',headers:{'Authorization':`token ${githubToken}`,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'},body:JSON.stringify(gistData)});
    if(r.ok){ updateSyncIndicator('synced','Synced!'); setTimeout(updateCloudStatus,2000); }
    else throw new Error(r.status);
  }catch(e){ console.error(e); updateSyncIndicator('error','Sync failed'); }
}

async function syncFromGist(force){
  if(!githubToken || !gistId) return;
  updateSyncIndicator('syncing','Loading from cloud...');
  try{
    const r=await fetch(`https://api.github.com/gists/${gistId}`,{headers:{'Authorization':`token ${githubToken}`,'Accept':'application/vnd.github.v3+json'}});
    if(r.ok){
      const j=await r.json(); const file=j.files['job-applications.json'];
      if(file && file.content){ const data=JSON.parse(file.content);
        if(Array.isArray(data.applications)){
          // merge strategy: prefer cloud when force or when it has more records
          if(force || (data.applications.length > applications.length)){
            applications = data.applications; localStorage.setItem('jobApplications', JSON.stringify(applications));
            renderApplications(); updateStats();
          }
        }
      }
      updateSyncIndicator('synced','Loaded from cloud!'); setTimeout(updateCloudStatus,2000);
    } else { throw new Error(r.status); }
  }catch(e){ console.error(e); updateSyncIndicator('error','Load failed'); }
}

function manualSync(){ if(githubToken){ if(gistId) syncToGist(); else createInitialGist(); } }

function updateCloudStatus(){
  const icon=document.getElementById('statusIcon'); const text=document.getElementById('statusText'); const box=document.getElementById('cloudStatus'); const btn=document.getElementById('syncBtn');
  if(githubToken){ icon.textContent='✅'; text.textContent = gistId? 'Connected - Auto-backup enabled':'Connected - Setting up backup...'; box.className='cloud-status status-connected'; btn.disabled=false; }
  else { icon.textContent='❌'; text.textContent='Not connected - Enter GitHub token above'; box.className='cloud-status status-disconnected'; btn.disabled=true; }
}

function updateSyncIndicator(status,text){ const el=document.getElementById('syncIndicator'); el.className=`sync-indicator ${status}`; el.textContent=text; el.style.display='inline-flex'; const st=document.getElementById('statusText'); if(status==='syncing') st.textContent=text; else if(status==='synced') st.textContent='Connected - Auto-backup enabled'; else if(status==='error') st.textContent='Connection error - Check token'; }

// Auto pull on first load if token+gistId exist and local is empty
if (githubToken && gistId && (!applications || applications.length===0)) { syncFromGist(true); }

// Periodic autosync every 5 minutes
setInterval(()=>{ if(autoSyncEnabled && githubToken && gistId && applications.length>0){ syncToGist(); } }, 5*60*1000);

</script>
</body>
</html>